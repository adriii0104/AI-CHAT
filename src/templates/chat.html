<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        .typing-animation {
            animation: typing 1s linear;
        }

        .listening {
            color: red;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Madurai&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/euclid-circular-a" rel="stylesheet">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-straight/css/uicons-regular-straight.css'>
</head>
<body>
    <a href="{{ url_for('salir') }}"><i class="fi fi-tr-circle-xmark"></i></a>
    <div id="chat-window">
        <ul id="message-list"></ul>
    </div>
    <div class="chat-container">
        <div id="user-input">
            <form id="user-form" onsubmit="event.preventDefault(); sendMessage();">
                <input type="text" id="user-message" placeholder="Escribe un mensaje..." autocomplete="off">
                <button type="submit" id="send-btn"><i class="fi fi-tr-paper-plane-top"></i></button>
                <button type="button" id="audio-btn" onclick="startListening()"><i class="fi fi-tr-circle-microphone"></i></button>
                <input type="hidden" id="user-message" />
            </form>
        </div>
    </div>
    <script>
        var recognition;
        var isListening = false;

        function startListening() {
            if (isListening) {
                recognition.stop();
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onstart = function() {
                document.getElementById("audio-btn").classList.add("listening");
                isListening = true;
            };

            recognition.onresult = function(event) {
                var result = event.results[event.results.length - 1][0].transcript;
                document.getElementById("user-input").classList.add("listening");
                document.getElementById("user-message").value = result;
                sendMessage();
            };

            recognition.onend = function() {
                document.getElementById("audio-btn").classList.remove("listening");
                document.getElementById("user-input").classList.remove("listening");
                isListening = false; // Reiniciar la variable isListening a false
            };

            recognition.start();
        }

        function sendMessage() {
            var userMessage = document.getElementById("user-message").value;
            var messageList = document.getElementById("message-list");

            // Agregar el mensaje del usuario a la lista de mensajes
            var userMessageItem = document.createElement("li");
            userMessageItem.classList.add("user-message");
            userMessageItem.textContent = "Tú: " + userMessage;
            messageList.appendChild(userMessageItem);

            // Agregar animación de escritura al mensaje del chatbot
            var typingAnimation = document.createElement("span");
            typingAnimation.classList.add("typing-animation");
            typingAnimation.textContent = "Corin Bot: ";
            var chatbotMessageItem = document.createElement("li");
            chatbotMessageItem.classList.add("chatbot-message");
            chatbotMessageItem.appendChild(typingAnimation);
            messageList.appendChild(chatbotMessageItem);

            // Enviar el mensaje al servidor para obtener la respuesta
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;

                    // Remover animación de escritura
                    chatbotMessageItem.removeChild(typingAnimation);

                    // Agregar la respuesta del chatbot a la lista de mensajes
                    var chatbotResponseItem = document.createElement("span");
                    chatbotResponseItem.textContent = response;
                    chatbotMessageItem.appendChild(chatbotResponseItem);

                    // Limpiar el campo de entrada de usuario
                    document.getElementById("user-message").value = "";

                    // Desplazarse al final de la lista de mensajes
                    messageList.scrollTop = messageList.scrollHeight;
                }
            };

            // Enviar el mensaje de texto al servidor
            xhttp.open("POST", "/get_response", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send("user_message=" + userMessage);
        }
    </script>
    <script src="{{ url_for('static', filename='JS/scripts.js') }}"></script>
</body>
</html>
